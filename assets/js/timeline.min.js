(()=>{"use strict";class t{constructor(t,e){this.timeline=e,this.startYear=parseFloat(t.dataset.start);const n=t.dataset.end;this.endYear="present"===n?n:parseFloat(n),this.color=`#${t.dataset.color}`,this.backgroundColor=i(this.color,e.style.infoBackgroundAlpha),this.info=t.innerText.trim(),this.xCoord=null}computeInfoLayout(){const t=this.timeline.canvas.context,e=this.timeline.style,i={lineArr:[],bottomY:this.timeline.yearsYCoords[this.startYear]},n=this.info.split(" "),o=[];let s,r=n[0],a=t.measureText(n[0]).width;return this.xCoord>=this.timeline.centerXCoord?(i.lineXDest=this.timeline.infoRightXCoord,s=this.timeline.currentWidth-i.lineXDest-this.timeline.yearXOffset):(i.lineXDest=this.timeline.infoLeftXCoord,s=i.lineXDest),s-=2*e.infoBackgroundPadding,n.slice(1).forEach((e=>{const n=`${r} ${e}`,h=t.measureText(n).width;h>s||r.endsWith(",")?(i.lineArr.push(r),o.push(a),r=e,a=h-a):(r=n,a=h)})),i.lineArr.push(r),o.push(a),i.width=Math.max(...o)+2*e.infoBackgroundPadding,i.height=e.infoLineHeight*i.lineArr.length+2*e.infoBackgroundPadding,i}drawEventLine(){const t=this.timeline.canvas.context,e=this.timeline.style.eventWidth,i=this.timeline.yearsYCoords;if(t.beginPath(),t.lineWidth=e,t.lineCap="round",t.moveTo(this.xCoord,i[this.startYear]+e/2),"present"===this.endYear){const e=t.createLinearGradient(this.xCoord,i[this.startYear],this.xCoord,this.timeline.currentHeight);e.addColorStop(.25,this.color),e.addColorStop(1,this.timeline.style.backgroundColor),t.strokeStyle=e,t.lineTo(this.xCoord,this.timeline.currentHeight)}else t.strokeStyle=this.color,t.lineTo(this.xCoord,i[this.endYear]-e/2);t.stroke()}drawInfo(t){const e=this.timeline.canvas.context,o=this.timeline.style;let s=t.lineXDest,r=t.bottomY,a=s,h=this.timeline.yearsYCoords[this.startYear+o.infoYOffset];this.xCoord>=this.timeline.centerXCoord?s+=o.infoBackgroundRadius/2:(s-=o.infoBackgroundRadius/2,a-=t.width),"present"!==this.endYear&&this.endYear-this.startYear<=o.infoYOffset&&(h=Math.round((this.timeline.yearsYCoords[this.startYear]+this.timeline.yearsYCoords[this.endYear])/2)),t.bottomY<h?r-=o.infoBackgroundRadius/2:t.bottomY-t.height>h?r-=t.height-o.infoBackgroundRadius/2:r-=t.height/2,e.strokeStyle=i(this.color,o.infoLineAlpha),e.lineWidth=o.infoLineWidth,e.beginPath(),e.moveTo(this.xCoord,h),e.lineTo(Math.round(s),Math.round(r)),e.stroke(),e.fillStyle=o.backgroundColor,n(e,a,t.bottomY-t.height,t.width,t.height,o.infoBackgroundRadius),e.fillStyle=this.backgroundColor,n(e,a,t.bottomY-t.height,t.width,t.height,o.infoBackgroundRadius),e.beginPath(),e.font=`${o.infoFontSize}px sans-serif`,e.fillStyle=o.infoFontColor,e.textBaseline="bottom",e.textAlign="left",e.lineJoin="round",t.lineArr.forEach(((i,n,s)=>{e.fillText(i,a+o.infoBackgroundPadding,t.bottomY-o.infoBackgroundPadding-o.infoLineHeight*(s.length-1-n)),i.endsWith(",")&&(e.font=`italic ${o.infoFontSize}px sans-serif`)}))}}class e{constructor(t){this.timelineElement=t,this.currentWidth=t.clientWidth,this.currentHeight=t.clientHeight,this.startYear=parseInt(t.dataset.start,10),this.endYear=parseInt(t.dataset.end,10),this.initCanvas(t),this.getStyles(),this.parseEvents(),this.precomputeStaticValues(),this.computeBaseLayout(),this.computeEventLayout(),this.drawBase(),this.drawEvents()}adjustEventInfo(t){[this.infoLeftXCoord,this.infoRightXCoord].forEach((e=>{const i=t.filter((t=>t.lineXDest===e));i.slice(1).forEach(((t,e)=>{const n=t.bottomY-t.height,o=i[e];if(n<o.bottomY+this.style.infoMinPaddingY){const s=o.bottomY+this.style.infoMinPaddingY-n;let r=o.bottomY-o.height;e>0&&(r-=i[e-1].bottomY+this.style.infoMinPaddingY),r>=s?o.bottomY-=s:(o.bottomY-=r,t.bottomY+=s-r)}}))}))}computeBaseLayout(){const t=this.style.verticalPadding,e=(this.currentHeight-this.style.verticalPadding-t)/(4*(this.endYear-this.startYear)),i={},n={};for(let o=this.startYear,s=t;o<=this.endYear;o+=.25,s+=e)i[o]=Math.floor(s),n[o]=Array(this.events.length).fill(0);this.yearsYCoords=i,this.occupiedGrid=n,this.centerXCoord=Math.round((this.currentWidth-this.yearXOffset)/2)}computeEventLayout(){const t=[this.centerXCoord];let e=1;for(;t.length<this.events.length;){const i=e*(this.style.eventWidth+this.style.eventOffset);t.push(this.centerXCoord+i),t.length<this.events.length&&t.push(this.centerXCoord-i),e++}const i=[];this.events.forEach((e=>{const n=this.occupiedGrid[e.startYear].indexOf(0),o=t[n];e.xCoord=o,i.push(o);let s=e.endYear;"present"===s&&(s=this.endYear);for(let t=e.startYear;t<s;t+=.25)this.occupiedGrid[t][n]=1})),this.infoLeftXCoord=Math.min(...i)-this.style.infoXOffset,this.infoRightXCoord=Math.max(...i)+this.style.infoXOffset}drawBase(){const t=this.canvas.context;t.beginPath(),t.fillStyle=this.style.yearColor,t.textAlign="right",t.font=`${this.style.yearFontSize}px sans-serif`,t.strokeStyle=this.style.gridlineColor,t.lineWidth=this.style.gridlineWidth,Object.entries(this.yearsYCoords).forEach((([e,i])=>{Number.isInteger(Number(e))&&(t.fillText(e,this.currentWidth,Math.round(i+this.style.yearFontSize/2)),t.moveTo(0,i),t.lineTo(this.currentWidth-this.yearXOffset,i))})),t.stroke()}drawEvents(){const t=[];this.canvas.context.font=`${this.style.infoFontSize}px sans-serif`,this.events.forEach((e=>{t.push(e.computeInfoLayout())})),this.adjustEventInfo(t),this.events.forEach(((e,i)=>{e.drawInfo(t[i]),e.drawEventLine()}))}getStyles(){const t=getComputedStyle(this.timelineElement),e=t.getPropertyValue("--background-color").trim(),n=parseFloat(t.getPropertyValue("--background-alpha")),o=t.getPropertyValue("--year-color").trim(),s=parseFloat(t.getPropertyValue("--year-alpha")),r=t.getPropertyValue("--gridline-color").trim(),a=parseFloat(t.getPropertyValue("--gridline-alpha")),h=t.getPropertyValue("--info-font-color").trim(),l=parseInt(t.getPropertyValue("--info-font-alpha"),10),d=parseInt(t.getPropertyValue("--info-font-size"),10);this.style={verticalPadding:parseInt(t.getPropertyValue("--vertical-padding"),10),yearFontSize:parseInt(t.getPropertyValue("--year-font-size"),10),gridlineWidth:parseInt(t.getPropertyValue("--gridline-width"),10),eventWidth:parseInt(t.getPropertyValue("--event-width"),10),eventOffset:parseInt(t.getPropertyValue("--event-offset"),10),infoLineWidth:parseInt(t.getPropertyValue("--info-line-width"),10),infoLineAlpha:parseFloat(t.getPropertyValue("--info-line-alpha")),infoXOffset:parseInt(t.getPropertyValue("--info-x-offset"),10),infoYOffset:parseFloat(t.getPropertyValue("--info-y-offset")),infoMinPaddingY:parseInt(t.getPropertyValue("--info-min-padding-y"),10),infoFontSize:d,infoLineHeight:Math.round(d*parseFloat(t.getPropertyValue("--info-line-height"))),infoBackgroundPadding:parseInt(t.getPropertyValue("--info-background-padding"),10),infoBackgroundRadius:parseInt(t.getPropertyValue("--info-background-radius"),10),infoBackgroundAlpha:parseFloat(t.getPropertyValue("--info-background-alpha")),backgroundColor:i(e,n),yearColor:i(o,s),gridlineColor:i(r,a),infoFontColor:i(h,l)}}initCanvas(t){const e=document.createElement("canvas"),i=e.getContext("2d");e.className="timeline-canvas-el",e.width=t.clientWidth*devicePixelRatio,e.height=t.clientHeight*devicePixelRatio,i.scale(devicePixelRatio,devicePixelRatio),e.style.width=`${t.clientWidth}px`,e.style.height=`${t.clientHeight}px`,t.appendChild(e),this.canvas={element:e,context:i}}onResize(){const t=this.timelineElement.clientWidth,e=this.timelineElement.clientHeight;t===this.currentWidth&&e===this.currentHeight||(this.canvas.context.clearRect(0,0,this.currentWidth,this.currentHeight),this.canvas.element.width=t*devicePixelRatio,this.canvas.element.height=e*devicePixelRatio,this.canvas.context.scale(devicePixelRatio,devicePixelRatio),this.canvas.element.style.width=`${t}px`,this.canvas.element.style.height=`${e}px`,this.currentWidth=t,this.currentHeight=e,this.computeBaseLayout(),this.computeEventLayout(),this.drawBase(),this.drawEvents())}parseEvents(){const e=this.timelineElement.getElementsByTagName("li"),i=[];Array.prototype.forEach.call(e,(e=>{i.push(new t(e,this))})),this.events=i}precomputeStaticValues(){const t=this.canvas.context;t.font=`${this.style.yearFontSize}px sans-serif`,t.textBaseline="bottom",this.yearXOffset=Math.round(t.measureText("00000").width)}}const i=(t,e=1)=>{const i=t.replace("#","");return`rgba(${parseInt(i.substring(0,2),16)},${parseInt(i.substring(2,4),16)},${parseInt(i.substring(4,6),16)},${e})`},n=(t,e,i,n,o,s)=>{t.beginPath(),t.moveTo(e,i+s),t.lineTo(e,i+o-s),t.quadraticCurveTo(e,i+o,e+s,i+o),t.lineTo(e+n-s,i+o),t.quadraticCurveTo(e+n,i+o,e+n,i+o-s),t.lineTo(e+n,i+s),t.quadraticCurveTo(e+n,i,e+n-s,i),t.lineTo(e+s,i),t.quadraticCurveTo(e,i,e,i+s),t.closePath(),t.fill()},o=document.getElementById("timeline");null!==o&&window.addEventListener("load",(()=>{const t=new e(o);window.timeline=t,window.addEventListener("resize",(()=>t.onResize()))}))})();