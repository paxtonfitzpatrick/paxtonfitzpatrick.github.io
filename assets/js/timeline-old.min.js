const TimelineDisplayer=function(e,t,n){"use strict";this.timelineObj={canvas:{el:n,curr_height:n.height,curr_width:n.width},timeline_el:{el:t,curr_height:t.offsetHeight},start_year:parseInt(t.dataset.start),end_year:parseInt(t.dataset.end),years_ycoords:{},occupied_grid:{},events:[],style:{},functions:{timeline:{},events:{},utils:{}}};const i=this.timelineObj;i.functions.timeline.init=function(){i.canvas.ctx=i.canvas.el.getContext("2d"),i.functions.timeline.getStyle(),i.functions.timeline.computeTimelineLayout()},i.functions.timeline.computeTimelineLayout=function(){i.top_y=i.style.vertical_padding,i.bottom_y=i.canvas.el.height-i.style.vertical_padding,i.functions.events.parseEvents();const e=(i.bottom_y-i.top_y)/(4*(i.end_year-i.start_year));for(let t=i.start_year,n=i.top_y;t<=i.end_year;t+=.25,n+=e)i.years_ycoords[t]=Math.floor(n),i.occupied_grid[t]=Array(i.events.length).fill(0)},i.functions.timeline.getStyle=function(){const e=getComputedStyle(t);i.style.vertical_padding=parseInt(e.getPropertyValue("--vertical-padding")),i.style.year_fontsize=e.getPropertyValue("--year-font-size").trim(),i.style.gridline_width=parseInt(e.getPropertyValue("--gridline-width")),i.style.event_width=parseInt(e.getPropertyValue("--event-width")),i.style.event_offset=parseInt(e.getPropertyValue("--event-offset")),i.style.info_line_width=parseInt(e.getPropertyValue("--info-line-width")),i.style.info_x_offset=parseInt(e.getPropertyValue("--info-x-offset")),i.style.info_y_offset=parseFloat(e.getPropertyValue("--info-y-offset")),i.style.info_fontsize=e.getPropertyValue("--info-font-size").trim();const n=e.getPropertyValue("--background-color").trim(),s=parseFloat(e.getPropertyValue("--background-alpha")),a=e.getPropertyValue("--year-color").trim(),o=parseFloat(e.getPropertyValue("--year-alpha")),r=e.getPropertyValue("--gridline-color").trim(),l=parseFloat(e.getPropertyValue("--gridline-alpha")),c=e.getPropertyValue("--info-font-color").trim(),f=parseInt(e.getPropertyValue("--info-font-alpha"));i.style.background_color=i.functions.utils.hexToRGBA(n,s),i.style.year_color=i.functions.utils.hexToRGBA(a,o),i.style.gridline_color=i.functions.utils.hexToRGBA(r,l),i.style.info_font_color=i.functions.utils.hexToRGBA(c,f)},i.functions.timeline.computeEventLayout=function(){const e=[i.center_x];let t=1;for(;e.length<i.events.length;){const n=t*(i.style.event_width+i.style.event_offset);e.push(i.center_x+n),e.length<i.events.length&&e.push(i.center_x-n),t++}for(let t in i.events){const n=i.events[t],s=i.occupied_grid[n.start_year].indexOf(0);n.x_coord=e[s];for(let e=n.start_year;e<n.end_year;e+=.25)i.occupied_grid[e][s]=1}},i.functions.timeline.drawBase=function(){i.canvas.ctx.beginPath(),i.canvas.ctx.fillStyle=i.style.year_color,i.canvas.ctx.textAlign="right",i.canvas.ctx.font=`${i.style.year_fontsize} sans-serif`,i.canvas.ctx.strokeStyle=i.style.gridline_color,i.canvas.lineWidth=i.style.gridline_width;const e=i.canvas.ctx.measureText("00000").width,t=i.functions.utils.getTextLineHeight("0")/2;i.canvas.gridline_x_offset=e;for(let n in i.years_ycoords){const s=Number(n);Number.isInteger(s)&&(i.canvas.ctx.fillText(s,i.canvas.el.width,i.years_ycoords[s]+t),i.canvas.ctx.moveTo(0,i.years_ycoords[s]),i.canvas.ctx.lineTo(i.canvas.el.width-e,i.years_ycoords[s]))}i.canvas.ctx.stroke(),i.center_x=Math.floor(i.canvas.el.width/2-e)},i.functions.events.TimelineEvent=function(e){this.info=e.id.replace("timeline-event-","").replace(/_/g," "),this.start_year=parseFloat(e.dataset.start),this.end_year=parseFloat(e.dataset.end),this.color=`#${e.dataset.color}`},i.functions.events.TimelineEvent.prototype.draw=function(){i.canvas.ctx.beginPath(),i.canvas.ctx.lineWidth=i.style.event_width,i.canvas.ctx.strokeStyle=this.color,i.canvas.ctx.lineCap="round",i.canvas.ctx.moveTo(this.x_coord,i.years_ycoords[this.start_year]+i.style.event_width/2),i.canvas.ctx.lineTo(this.x_coord,i.years_ycoords[this.end_year]-i.style.event_width/2),i.canvas.ctx.stroke()},i.functions.events.drawInfo=function(){const e=Math.min.apply(Math,i.events.map((function(e){return e.x_coord})))-i.style.info_x_offset,t=Math.max.apply(Math,i.events.map((function(e){return e.x_coord})))+i.style.info_x_offset;for(let n of i.events){i.canvas.ctx.beginPath(),i.canvas.ctx.strokeStyle=n.color,i.canvas.ctx.lineWidth=i.style.info_line_width,i.canvas.ctx.fillStyle=i.style.info_font_color,i.canvas.ctx.font=`${i.style.info_fontsize} sans-serif`,i.canvas.ctx.textBaseline="bottom";const s=i.functions.events.formatInfoLayout(n,e,t);i.canvas.ctx.textAlign=s.alignment;for(let e in s.line_arr)i.canvas.ctx.fillText(s.line_arr[e],s.x,i.years_ycoords[n.start_year]-1.3*s.line_height*(s.line_arr.length-1-e));let a=i.years_ycoords[n.start_year+i.style.info_y_offset];n.end_year-n.start_year<=i.style.info_y_offset&&(a=Math.floor((i.years_ycoords[n.end_year]+i.years_ycoords[n.start_year])/2)),i.canvas.ctx.moveTo(n.x_coord,a),i.canvas.ctx.lineTo(s.x,i.years_ycoords[n.start_year]+.3*s.line_height),i.canvas.ctx.lineTo(s.underline_x,i.years_ycoords[n.start_year]+.3*s.line_height),i.canvas.ctx.stroke()}},i.functions.events.formatInfoLayout=function(e,t,n){let s,a={},o=e.info.split(" "),r=o[0];e.x_coord>=i.center_x?(a.x=n,a.alignment="left",s=i.canvas.el.width-a.x):(a.x=t,a.alignment="right",s=a.x),a.line_arr=[];for(let e of o.slice(1)){const t=`${r} ${e}`;i.canvas.ctx.measureText(t).width>s||r.endsWith(",")?(a.line_arr.push(r),r=e):r=t}return a.line_arr.push(r),a.width=Math.max.apply(Math,a.line_arr.map((e=>i.canvas.ctx.measureText(e).width))),a.line_height=i.functions.utils.getTextLineHeight(a.line_arr[0]),a.underline_x="left"===a.alignment?a.x+a.width:a.x-a.width,a},i.functions.events.parseEvents=function(){const t=document.querySelector(`#${e} > .timeline-events`).getElementsByTagName("li");for(let e of t)i.events.push(new i.functions.events.TimelineEvent(e))},i.functions.utils.onResize=function(){const e=i.timeline_el.el.clientHeight;if(e!==i.timeline_el.curr_height){i.canvas.ctx.clearRect(0,0,i.canvas.curr_width,i.canvas.curr_height),i.canvas.el.height=e,i.canvas.el.width=i.timeline_el.el.clientWidth,i.events=[],i.occupied_grid={},i.functions.timeline.computeTimelineLayout(),i.functions.timeline.drawBase(),i.functions.timeline.computeEventLayout();for(let e of i.events)e.draw();i.functions.events.drawInfo(),i.timeline_el.curr_height=e,i.canvas.curr_width=i.canvas.el.width,i.canvas.curr_height=i.canvas.el.height}},i.functions.utils.hexToRGBA=function(e,t=1){const n=e.replace("#","");return`rgba(${parseInt(n.substring(0,2),16)},${parseInt(n.substring(2,4),16)},${parseInt(n.substring(4,6),16)},${t})`},i.functions.utils.getTextLineHeight=function(e){const t=i.canvas.ctx.measureText(e);return Math.floor(t.actualBoundingBoxAscent)},i.functions.launch=function(){i.functions.timeline.init(),i.functions.timeline.drawBase(),i.functions.timeline.computeEventLayout();for(let e of i.events)e.draw();i.functions.events.drawInfo(),window.addEventListener("resize",i.functions.utils.onResize)},i.functions.launch()};window.timelineDom=[],window.timelineDisplay=function(e){"use strict";const t=document.getElementById(e),n=document.createElement("canvas");n.className="timeline-canvas-el",n.width=t.clientWidth,n.height=t.clientHeight,n.style.width="100%",n.style.height="100%",n.style.position="absolute";const i=t.appendChild(n);null!=i&&timelineDom.push(new TimelineDisplayer(e,t,i))},timelineDisplay("timeline");